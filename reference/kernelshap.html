<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Kernel SHAP — kernelshap • kernelshap</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- dalexverse --><link href="../dalexverse.css" rel="stylesheet"><link href="../dalexverse-2.css" rel="stylesheet"><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Kernel SHAP — kernelshap"><meta property="og:description" content="Efficient implementation of Kernel SHAP, see Lundberg and Lee (2017), and
Covert and Lee (2021), abbreviated by CL21.
For up to \(p=8\) features, the resulting Kernel SHAP values are exact regarding
the selected background data. For larger \(p\), an almost exact
hybrid algorithm involving iterative sampling is used, see Details."><meta property="og:image" content="/logo.png"><meta name="robots" content="noindex"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-5650686-14"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-5650686-14');
</script></head><body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">kernelshap</a>
        <div class="info">
          <span class="partof">part of the <a href="https://github.com/ModelOriented/DrWhy" class="external-link">DrWhy.AI</a>
           developed by the <a href="https://mi2.ai/" class="external-link">MI².AI</a> </span>
          <span class="version version-default">0.4.0</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/ModelOriented/kernelshap/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Kernel SHAP</h1>
    <small class="dont-index">Source: <a href="https://github.com/ModelOriented/kernelshap/blob/HEAD/R/kernelshap.R" class="external-link"><code>R/kernelshap.R</code></a></small>
    <div class="hidden name"><code>kernelshap.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Efficient implementation of Kernel SHAP, see Lundberg and Lee (2017), and
Covert and Lee (2021), abbreviated by CL21.
For up to \(p=8\) features, the resulting Kernel SHAP values are exact regarding
the selected background data. For larger \(p\), an almost exact
hybrid algorithm involving iterative sampling is used, see Details.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">kernelshap</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for default</span></span>
<span><span class="fu">kernelshap</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">X</span>,</span>
<span>  <span class="va">bg_X</span>,</span>
<span>  pred_fun <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span>,</span>
<span>  feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>,</span>
<span>  bg_w <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  exact <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">8L</span>,</span>
<span>  hybrid_degree <span class="op">=</span> <span class="fl">1L</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">4</span><span class="op">:</span><span class="fl">16</span>,</span>
<span>  paired_sampling <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">2L</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1L</span> <span class="op">+</span> <span class="fl">3L</span> <span class="op">*</span> <span class="op">(</span><span class="va">hybrid_degree</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  tol <span class="op">=</span> <span class="fl">0.005</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  parallel_args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for ranger</span></span>
<span><span class="fu">kernelshap</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">X</span>,</span>
<span>  <span class="va">bg_X</span>,</span>
<span>  pred_fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">X</span>, <span class="va">...</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span>,</span>
<span>  feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>,</span>
<span>  bg_w <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  exact <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">8L</span>,</span>
<span>  hybrid_degree <span class="op">=</span> <span class="fl">1L</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">4</span><span class="op">:</span><span class="fl">16</span>,</span>
<span>  paired_sampling <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">2L</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1L</span> <span class="op">+</span> <span class="fl">3L</span> <span class="op">*</span> <span class="op">(</span><span class="va">hybrid_degree</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  tol <span class="op">=</span> <span class="fl">0.005</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  parallel_args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for Learner</span></span>
<span><span class="fu">kernelshap</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">X</span>,</span>
<span>  <span class="va">bg_X</span>,</span>
<span>  pred_fun <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>,</span>
<span>  bg_w <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  exact <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">8L</span>,</span>
<span>  hybrid_degree <span class="op">=</span> <span class="fl">1L</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">4</span><span class="op">:</span><span class="fl">16</span>,</span>
<span>  paired_sampling <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  m <span class="op">=</span> <span class="fl">2L</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_names</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1L</span> <span class="op">+</span> <span class="fl">3L</span> <span class="op">*</span> <span class="op">(</span><span class="va">hybrid_degree</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  tol <span class="op">=</span> <span class="fl">0.005</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  parallel_args <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>object</dt>
<dd><p>Fitted model object.</p></dd>


<dt>...</dt>
<dd><p>Additional arguments passed to <code>pred_fun(object, X, ...)</code>.</p></dd>


<dt>X</dt>
<dd><p>\((n \times p)\) matrix or <code>data.frame</code> with rows to be explained.
The columns should only represent model features, not the response
(but see <code>feature_names</code> on how to overrule this).</p></dd>


<dt>bg_X</dt>
<dd><p>Background data used to integrate out "switched off" features,
often a subset of the training data (typically 50 to 500 rows)
It should contain the same columns as <code>X</code>.
In cases with a natural "off" value (like MNIST digits),
this can also be a single row with all values set to the off value.</p></dd>


<dt>pred_fun</dt>
<dd><p>Prediction function of the form <code>function(object, X, ...)</code>,
providing \(K \ge 1\) numeric predictions per row. Its first argument
represents the model <code>object</code>, its second argument a data structure like <code>X</code>.
Additional (named) arguments are passed via <code>...</code>.
The default, <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">stats::predict()</a></code>, will work in most cases.</p></dd>


<dt>feature_names</dt>
<dd><p>Optional vector of column names in <code>X</code> used to calculate
SHAP values. By default, this equals <code>colnames(X)</code>. Not supported if <code>X</code>
is a matrix.</p></dd>


<dt>bg_w</dt>
<dd><p>Optional vector of case weights for each row of <code>bg_X</code>.</p></dd>


<dt>exact</dt>
<dd><p>If <code>TRUE</code>, the algorithm will produce exact Kernel SHAP values
with respect to the background data. In this case, the arguments <code>hybrid_degree</code>,
<code>m</code>, <code>paired_sampling</code>, <code>tol</code>, and <code>max_iter</code> are ignored.
The default is <code>TRUE</code> up to eight features, and <code>FALSE</code> otherwise.</p></dd>


<dt>hybrid_degree</dt>
<dd><p>Integer controlling the exactness of the hybrid strategy. For
\(4 \le p \le 16\), the default is 2, otherwise it is 1.
Ignored if <code>exact = TRUE</code>.</p><ul><li><p><code>0</code>: Pure sampling strategy not involving any exact part. It is strictly
worse than the hybrid strategy and should therefore only be used for
studying properties of the Kernel SHAP algorithm.</p></li>
<li><p><code>1</code>: Uses all \(2p\) on-off vectors \(z\) with \(\sum z \in \{1, p-1\}\)
for the exact part, which covers at least 75% of the mass of the Kernel weight
distribution. The remaining mass is covered by random sampling.</p></li>
<li><p><code>2</code>: Uses all \(p(p+1)\) on-off vectors \(z\) with
\(\sum z \in \{1, 2, p-2, p-1\}\). This covers at least 92% of the mass of the
Kernel weight distribution. The remaining mass is covered by sampling.
Convergence usually happens in the minimal possible number of iterations of two.</p></li>
<li><p><code>k&gt;2</code>: Uses all on-off vectors with
\(\sum z \in \{1, \dots, k, p-k, \dots, p-1\}\).</p></li>
</ul></dd>


<dt>paired_sampling</dt>
<dd><p>Logical flag indicating whether to do the sampling in a paired
manner. This means that with every on-off vector \(z\), also \(1-z\) is
considered. CL21 shows its superiority compared to standard sampling, therefore the
default (<code>TRUE</code>) should usually not be changed except for studying properties
of Kernel SHAP algorithms. Ignored if <code>exact = TRUE</code>.</p></dd>


<dt>m</dt>
<dd><p>Even number of on-off vectors sampled during one iteration.
The default is \(2p\), except when <code>hybrid_degree == 0</code>.
Then it is set to \(8p\). Ignored if <code>exact = TRUE</code>.</p></dd>


<dt>tol</dt>
<dd><p>Tolerance determining when to stop. Following CL21, the algorithm keeps
iterating until \(\textrm{max}(\sigma_n)/(\textrm{max}(\beta_n) - \textrm{min}(\beta_n)) &lt; \textrm{tol}\),
where the \(\beta_n\) are the SHAP values of a given observation,
and \(\sigma_n\) their standard errors.
For multidimensional predictions, the criterion must be satisfied for each
dimension separately. The stopping criterion uses the fact that standard errors
and SHAP values are all on the same scale. Ignored if <code>exact = TRUE</code>.</p></dd>


<dt>max_iter</dt>
<dd><p>If the stopping criterion (see <code>tol</code>) is not reached after
<code>max_iter</code> iterations, the algorithm stops. Ignored if <code>exact = TRUE</code>.</p></dd>


<dt>parallel</dt>
<dd><p>If <code>TRUE</code>, use parallel <code><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach::foreach()</a></code> to loop over rows
to be explained. Must register backend beforehand, e.g., via doFuture package,
see README for an example. Parallelization automatically disables the progress bar.</p></dd>


<dt>parallel_args</dt>
<dd><p>Named list of arguments passed to <code><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach::foreach()</a></code>.
Ideally, this is <code>NULL</code> (default). Only relevant if <code>parallel = TRUE</code>.
Example on Windows: if <code>object</code> is a GAM fitted with package mgcv,
then one might need to set <code>parallel_args = list(.packages = "mgcv")</code>.</p></dd>


<dt>verbose</dt>
<dd><p>Set to <code>FALSE</code> to suppress messages and the progress bar.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>An object of class "kernelshap" with the following components:</p><ul><li><p><code>S</code>: \((n \times p)\) matrix with SHAP values or, if the model output has
dimension \(K &gt; 1\), a list of \(K\) such matrices.</p></li>
<li><p><code>X</code>: Same as input argument <code>X</code>.</p></li>
<li><p><code>baseline</code>: Vector of length K representing the average prediction on the
background data.</p></li>
<li><p><code>SE</code>: Standard errors corresponding to <code>S</code> (and organized like <code>S</code>).</p></li>
<li><p><code>n_iter</code>: Integer vector of length n providing the number of iterations
per row of <code>X</code>.</p></li>
<li><p><code>converged</code>: Logical vector of length n indicating convergence per row of <code>X</code>.</p></li>
<li><p><code>m</code>: Integer providing the effective number of sampled on-off vectors used
per iteration.</p></li>
<li><p><code>m_exact</code>: Integer providing the effective number of exact on-off vectors used
per iteration.</p></li>
<li><p><code>prop_exact</code>: Proportion of the Kernel SHAP weight distribution covered by
exact calculations.</p></li>
<li><p><code>exact</code>: Logical flag indicating whether calculations are exact or not.</p></li>
<li><p><code>txt</code>: Summary text.</p></li>
<li><p><code>predictions</code>: \((n \times K)\) matrix with predictions of <code>X</code>.</p></li>
</ul></div>
    <div id="details">
    <h2>Details</h2>
    <p>Pure iterative Kernel SHAP sampling as in Covert and Lee (2021) works like this:</p><ol><li><p>A binary "on-off" vector \(z\) is drawn from \(\{0, 1\}^p\)
such that its sum follows the SHAP Kernel weight distribution
(normalized to the range \(\{1, \dots, p-1\}\)).</p></li>
<li><p>For each \(j\) with \(z_j = 1\), the \(j\)-th column of the
original background data is replaced by the corresponding feature value \(x_j\)
of the observation to be explained.</p></li>
<li><p>The average prediction \(v_z\) on the data of Step 2 is calculated, and the
average prediction \(v_0\) on the background data is subtracted.</p></li>
<li><p>Steps 1 to 3 are repeated \(m\) times. This produces a binary \(m \times p\)
matrix \(Z\) (each row equals one of the \(z\)) and a vector \(v\) of
shifted predictions.</p></li>
<li><p>\(v\) is regressed onto \(Z\) under the constraint that the sum of the
coefficients equals \(v_1 - v_0\), where \(v_1\) is the prediction of the
observation to be explained. The resulting coefficients are the Kernel SHAP values.</p></li>
</ol><p>This is repeated multiple times until convergence, see CL21 for details.</p>
<p>A drawback of this strategy is that many (at least 75%) of the \(z\) vectors will
have \(\sum z \in \{1, p-1\}\), producing many duplicates. Similarly, at least 92%
of the mass will be used for the \(p(p+1)\) possible vectors with
\(\sum z \in \{1, 2, p-2, p-1\}\).
This inefficiency can be fixed by a hybrid strategy, combining exact calculations
with sampling.</p>
<p>The hybrid algorithm has two steps:</p><ol><li><p>Step 1 (exact part): There are \(2p\) different on-off vectors \(z\) with
\(\sum z \in \{1, p-1\}\), covering a large proportion of the Kernel SHAP
distribution. The degree 1 hybrid will list those vectors and use them according
to their weights in the upcoming calculations. Depending on \(p\), we can also go
a step further to a degree 2 hybrid by adding all \(p(p-1)\) vectors with
\(\sum z \in \{2, p-2\}\) to the process etc. The necessary predictions are
obtained along with other calculations similar to those described in CL21.</p></li>
<li><p>Step 2 (sampling part): The remaining weight is filled by sampling vectors z
according to Kernel SHAP weights renormalized to the values not yet covered by Step 1.
Together with the results from Step 1 - correctly weighted - this now forms a
complete iteration as in CL21. The difference is that most mass is covered by exact
calculations. Afterwards, the algorithm iterates until convergence.
The output of Step 1 is reused in every iteration, leading to an extremely
efficient strategy.</p></li>
</ol><p>If \(p\) is sufficiently small, all possible \(2^p-2\) on-off vectors \(z\) can be
evaluated. In this case, no sampling is required and the algorithm returns exact
Kernel SHAP values with respect to the given background data.
Since <code>kernelshap()</code> calculates predictions on data with \(MN\) rows
(\(N\) is the background data size and \(M\) the number of \(z\) vectors), \(p\)
should not be much higher than 10 for exact calculations.
For similar reasons, degree 2 hybrids should not use \(p\) much larger than 40.</p>
    </div>
    <div id="methods-by-class-">
    <h2>Methods (by class)</h2>
    
<ul><li><p><code>kernelshap(default)</code>: Default Kernel SHAP method.</p></li>
<li><p><code>kernelshap(ranger)</code>: Kernel SHAP method for "ranger" models, see Readme for an example.</p></li>
<li><p><code>kernelshap(Learner)</code>: Kernel SHAP method for "mlr3" models, see Readme for an example.</p></li>
</ul></div>
    <div id="references">
    <h2>References</h2>
    
<ol><li><p>Scott M. Lundberg and Su-In Lee. A unified approach to interpreting model
predictions. Proceedings of the 31st International Conference on Neural
Information Processing Systems, 2017.</p></li>
<li><p>Ian Covert and Su-In Lee. Improving KernelSHAP: Practical Shapley Value
Estimation Using Linear Regression. Proceedings of The 24th International
Conference on Artificial Intelligence and Statistics, PMLR 130:3457-3465, 2021.</p></li>
</ol></div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># MODEL ONE: Linear regression</span></span></span>
<span class="r-in"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Select rows to explain (only feature columns)</span></span></span>
<span class="r-in"><span><span class="va">X_explain</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Select small background dataset (could use all rows here because iris is small) </span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">bg_X</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate SHAP values</span></span></span>
<span class="r-in"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">kernelshap</span><span class="op">(</span><span class="va">fit</span>, <span class="va">X_explain</span>, bg_X <span class="op">=</span> <span class="va">bg_X</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Exact Kernel SHAP values</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |                                                                      |   0%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================================================| 100%</span>
<span class="r-in"><span><span class="va">s</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SHAP values of first 2 observations:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Sepal.Width Petal.Length Petal.Width   Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]  0.21571169    -1.981893   0.3157855 0.5825284</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,] -0.03223278    -1.981893   0.3157855 0.5825284</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># MODEL TWO: Multi-response linear regression</span></span></span>
<span class="r-in"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">~</span> <span class="va">Petal.Length</span> <span class="op">+</span> <span class="va">Petal.Width</span> <span class="op">+</span> <span class="va">Species</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">kernelshap</span><span class="op">(</span><span class="va">fit</span>, <span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, bg_X <span class="op">=</span> <span class="va">bg_X</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Exact Kernel SHAP values</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |                                                                      |   0%  |                                                                              |==================                                                    |  25%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================================                  |  75%  |                                                                              |======================================================================| 100%</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Exact Kernel SHAP values</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   - 2 SHAP matrices of dim 4 x 3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   - baseline: 5.874392 3.068502</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   - m_exact: 6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SHAP values of first 2 observations:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Sepal.Length</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Petal.Length Petal.Width  Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    -2.165211 0.006007392 1.234918</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    -2.165211 0.006007392 1.234918</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Sepal.Width</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Petal.Length Petal.Width  Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]   -0.3696749  -0.6246925 1.315597</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]   -0.3696749  -0.6246925 1.315597</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Non-feature columns can be dropped via 'feature_names'</span></span></span>
<span class="r-in"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu">kernelshap</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">fit</span>, </span></span>
<span class="r-in"><span>  <span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="op">]</span>,</span></span>
<span class="r-in"><span>  bg_X <span class="op">=</span> <span class="va">bg_X</span>, </span></span>
<span class="r-in"><span>  feature_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Petal.Length"</span>, <span class="st">"Petal.Width"</span>, <span class="st">"Species"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Exact Kernel SHAP values</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |                                                                      |   0%  |                                                                              |==================                                                    |  25%  |                                                                              |===================================                                   |  50%  |                                                                              |====================================================                  |  75%  |                                                                              |======================================================================| 100%</span>
<span class="r-in"><span><span class="va">s</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SHAP values of first 2 observations:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Sepal.Length</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Petal.Length Petal.Width  Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]    -2.165211 0.006007392 1.234918</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]    -2.165211 0.006007392 1.234918</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Sepal.Width</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Petal.Length Petal.Width  Species</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]   -0.3696749  -0.6246925 1.315597</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]   -0.3696749  -0.6246925 1.315597</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Michael Mayer, David Watson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  </body></html>

